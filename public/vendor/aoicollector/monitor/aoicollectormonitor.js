app.directive("dynchart",function(){return{scope:{data:"="},link:function(o,t){t.sparkline(o.data,{type:"line",width:"100%",height:"50",lineWidth:2,maxSpotColor:"#ff0000",spotRadius:3,normalRangeMin:0,normalRangeMax:6,normalRangeColor:"#e5e5e5"})}}}),Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},app.controller("aoicollectorController",["$scope","$http","$interval","toasty",function(o,t,i,e){var n,r;o.aoiList=[],o.prodinfoList=[],o.totalruntime=0,o.nodejserror=!0,o.runtime="",o.socketserver="arushap34:3333",n=ws(o.socketserver,{}),r=n.channel("aoicollectormonitor"),r.connect(function(t,i){return t?(console.log(t),void(o.nodejserror=!0)):(o.nodejserror=!1,console.log("AoicollectorMonitor Connected"),r.emit("aoicollector:monitor:subscribe"),r.emit("aoicollector:prodinfo:subscribe"),void o.$apply())}),r.on("disconnect",function(){console.log("AoicollectorMonitor Disconnected"),o.nodejserror=!0,o.$apply()}),o.findIndexProdinfo=function(t){var i=$.map(o.prodinfoList,function(o,i){if(o.barcode==t)return i})[0];return i},setInterval(function(){o.aoiList.forEach(function(t,i){var e=t.lastUpdate.fromNow();o.aoiList[i].lastUpdateText=e})},5e3),r.on("aoicollector:monitor:channel",function(t){var i=10,e=JSON.parse(t);switch(o.totalruntime=e.total,e.mode){case"runtime":0==e.total?o.runtime="No hay inspecciones":o.runtime="Procesando "+e.current+" de "+e.total;break;default:e.tiempoEjecucion=(e.tiempoEjecucion/1e3).toFixed(2);var n=$.map(o.aoiList,function(o,t){if(o.aoibarcode==e.aoibarcode)return t})[0];if(void 0!=n){var r=o.aoiList[n];e.runtimeHistory=r.runtimeHistory,e.runtimeHistory.push(e.tiempoEjecucion),e.tiempoEjecucion>r.tiempoEjecucionMax?e.tiempoEjecucionMax=e.tiempoEjecucion:e.tiempoEjecucionMax=r.tiempoEjecucionMax,e.runtimeHistory.length>i&&(e.runtimeHistory=e.runtimeHistory.slice(1,11),e.tiempoEjecucionMax=Math.max.apply(null,e.runtimeHistory)),e.prodinfo=o.prodinfoList[o.findIndexProdinfo(e.aoibarcode)],void 0==r.lastUpdateText&&console.log("Error",r),e.lastUpdateText=r.lastUpdate.fromNow(),e.lastUpdate=moment(),o.aoiList[n]=e}else e.runtimeHistory=[0,e.tiempoEjecucion],e.tiempoEjecucionMax=e.tiempoEjecucion,e.lastUpdate=moment(),e.lastUpdateText=e.lastUpdate.fromNow(),e.prodinfo=o.prodinfoList[o.findIndexProdinfo(e.aoibarcode)],o.aoiList.push(e)}o.$apply()}),r.on("aoicollector:prodinfo:channel",function(t){var i=JSON.parse(t),e=o.findIndexProdinfo(i.produccion.barcode);void 0!=e?o.prodinfoList[e]=i.produccion:o.prodinfoList.push(i.produccion),o.$apply()})}]);