app.factory("Aoi",["$q","IaCore",function(o,e){var r,t,n=10,c=!1,i={};return i.info=function(i,a){return r=o.defer(),c||(c=!0,t=e.http({url:"prod/info/"+i+"?filter=1&allstocker=1",method:"GET",timeout:n}),t.result.promise.then(function(o){c=!1,r.resolve(o)},function(o){c=!1,r.reject(o)})),r.promise},i.rerun=function(){c=!1},i.cancel=function(){t.cancel()},i}]),app.factory("Inspector",["$q","$rootScope","IaCore","toasty","Panel",function(o,e,r,t,n){var c,i=function(o,e){return 0===o.indexOf(e)},a={};return a.nodeInit=function(o){c=o,c.on("inspector:login:response",function(o,r){t.clear(r),o&&(o.error?(t.error({title:"Inspector",msg:o.error,timeout:2e3}),console.error("inspector:auth:response",o)):t.success({title:"Inspector",msg:"Bienvenido "+o.fullname,timeout:2e3})),console.log("inspector:login:response",o),e.inspectorService=o,e.$digest()}),c.on("inspector:logout:response",function(o,r){t.clear(r),o&&(o.error?(t.error({title:"Inspector",msg:o.error,timeout:2e3}),console.error("inspector:logout:response",o)):t.success({title:"Inspector",msg:"Sesion finalizada",timeout:2e3})),e.inspectorService={},e.$digest()})},a.auth=function(o){if((i(o,"LOGIN")||i(o,"DLOGIN"))&&o.length>5&&e.aoiService.produccion.barcode){var r=o.match(/\d+/);r&&(r=r[0]);var n=o.replace("DLOGIN","").replace("LOGIN",""),a=n.replace(r,""),s={name:a,userid:r,aoibarcode:e.aoiService.produccion.barcode};e.inspectorService&&e.inspectorService.id?t.wait({title:"Inspector",msg:"Finalizando sesion",timeout:!1,onAdd:function(){c.emit("inspector:logout",s,this.id)}}):t.wait({title:"Inspector",msg:"Buscando datos de inspector",timeout:!1,onAdd:function(){c.emit("inspector:login",s,this.id)}})}},a}]),app.factory("Panel",function(){var o=10,e=19,r={};return r.valid=function(r){return!!r&&!(!$.isNumeric(r)||r.length!=o&&r.length!=e)},r}),app.controller("prodController",["$scope","$rootScope","$http","$timeout","$interval","IaCore","Aoi","Stocker","Panel","Inspector","toasty","cfpLoadingBar",function(o,e,r,t,n,c,i,a,s,l,p,d){var u,m;e.lastScannerCommand={cmd:"",toastId:0},e.configprod={wsocket:{host:"ARUSHAP34",port:"3333"},wservice:{host:"ARUSHAP34"},aoibarcode:c.storage({name:"aoibarcode"})},e.aoiService={},e.stockerService={},e.inspectorService={},e.socketserver=e.configprod.wsocket.host+":"+e.configprod.wsocket.port,o.lastProdinfoChannelData=moment(),o.prodInfoInterval=null,o.prodUpdateInterval=function(){o.prodInfoInterval=setInterval(function(){var e=moment().diff(o.lastProdinfoChannelData);e>1e4&&(o.getProdinfo(),o.lastProdinfoChannelData=moment())},1e3)},o.getProdinfo=function(){httpget=c.http({url:"http://"+e.configprod.wservice.host+"/iaserver/public/api/aoicollector/prodinfo/"+e.configprod.aoibarcode,method:"GET",timeout:10}),httpget.result.promise.then(function(o){console.log("getProdinfo()",e.configprod.aoibarcode,"Result:",o),e.stockerService&&a.autoscroll(e.stockerService.paneles)},function(o){console.log("getProdinfo()",e.configprod.aoibarcode,"Error:",o.error),p.error({title:"Produccion",msg:o.error,timeout:2e3})})},u=ws(e.socketserver,{}),m=u.channel("inspectordash"),m.connect(function(r,t){return r?void console.log(r):(console.log("Connected to server"),void 0!=e.configprod.aoibarcode?p.wait({title:"Produccion",msg:"Descargando informacion",timeout:!1,onAdd:function(){m.emit("start",e.configprod.aoibarcode,this.id)}}):console.log("No hay codigo de produccion definido"),void o.$apply())}),m.on("start:response",function(r,t){console.log("start:response",r),clearInterval(o.prodInfoInterval),r.trycatch?(p.clear(t),p.error({title:"Produccion",msg:r.trycatch,timeout:3e3})):(p.clear(t),r.error?p.error({title:"Produccion",msg:r.error,timeout:2e3}):p.success({title:"Produccion",msg:"Descarga completa",timeout:2e3}),e.aoiService=r,e.inspectorService=r.produccion.inspector,e.stockerService=r.produccion.stocker,e.stockerService&&a.autoscroll(e.stockerService.paneles)),m.emit("aoicollector:prodinfo:subscribe"),o.prodUpdateInterval(),o.$apply()}),m.on("aoicollector:prodinfo:channel",function(r){var t=JSON.parse(r);t.produccion.barcode.toUpperCase()==e.configprod.aoibarcode.toUpperCase()&&(console.log("aoicollector:prodinfo:channel",e.configprod.aoibarcode,"Info:",t),e.aoiService=t,e.inspectorService=t.produccion.inspector,e.stockerService=t.produccion.stocker,e.stockerService&&a.autoscroll(e.stockerService.paneles),o.lastProdinfoChannelData=moment(),o.$apply())}),m.on("disconnect",function(){console.log("InspectorDash Disconnected"),p.warning({title:"Produccion",msg:"Desconectado del servidor"}),clearInterval(o.prodInfoInterval),o.$apply()}),m.on("connect_error",function(){p.error({title:"Produccion",msg:"Error de conexion, servidor caido",timeout:5e3}),o.$apply()}),a.nodeInit(m),l.nodeInit(m),e.stockerConfigModeHide=function(){console.log("stockerConfigModeHide",o.stockerConfigMode)},e.StockerConfigSave=function(o,e){a.config(o,e)},e.printError=function(e,r,t){if(void 0!=r.error&&(r=r.error),r)switch(t){case"modal":c.modalError(o,r);break;default:p.error({title:e,msg:r,timeout:5e3})}},e.restartAoiData=function(o){p.wait({title:"Configuracion",msg:"Aplicando cambios...",timeout:!1,onAdd:function(){}}),void 0!=o&&(c.storage({name:"aoibarcode",value:o}),e.configprod.aoibarcode=o),e.aoiService={},m.emit("start",e.configprod.aoibarcode)};e.$on("scannerEvent:enter",function(o,r){switch(e.lastScannerCommand.cmd){case"CMDSTKREM":a.remove(r.value),e.lastScannerCommand.cmd="",p.clear(e.lastScannerCommand.toastId);break;case"CMDPANREM":a.panelRemove(r.value),e.lastScannerCommand.cmd="",p.clear(e.lastScannerCommand.toastId);break;default:""==e.lastScannerCommand.cmd&&0===r.value.toUpperCase().indexOf("CMD")&&p.wait({title:"Comando de etiqueta",msg:"Esperando escaneo del elemento",timeout:!1,onAdd:function(){e.lastScannerCommand={cmd:r.value.toUpperCase(),toastId:this.id}}}),l.auth(r.value),a.add(r.value),a.panelAdd(r.value)}})}]),app.controller("prodChartController",["$rootScope",function(o){o.renderPeriodChart=function(){if(void 0!=o.aoiService.produccion.period){var e=o.aoiService.produccion.period.map(function(o){return o.op}),r=e.filter(function(o,r){return e.indexOf(o)==r});$.each(r,function(e,r){var t=o.aoiService.produccion.period.filter(function(o,e){if(o.op==r)return o}),n=[];$.each(t,function(o,e){var r=new Date;n.push([Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),e.periodo.split(":")[0]),e.total])});var c=prodchart.series.map(function(o){return o.name}),i=c.indexOf(r);i<0?prodchart.addSeries({name:r,data:n}):prodchart.series[i].setData(n)})}}}]),app.controller("prodHeaderController",["$scope","$rootScope","IaCore",function(o,e,r){o.promptAoiSet=function(e){r.modal({scope:o,route:e,title:"AOI en produccion",type:"primary",controller:"promptAoiSetController"})},o.btnFormSelectOp=function(t){e.btnFormSelectOpProccessing||(e.btnFormSelectOpProccessing=!0,r.modal({scope:o,route:t,title:"Informacion de OP",type:"primary",controller:"btnFormSelectOpController"}))},o.promptStockerSet=function(e){r.modal({scope:o,route:e,title:"Nuevo stocker",type:"info",controller:"promptStockerSetController"})},o.promptStockerAddPanel=function(e){r.modal({scope:o,route:e,title:"Asignar panel a stocker",type:"warning",controller:"promptStockerAddPanelController"})},o.promptStockerReset=function(e){r.modal({scope:o,route:e,title:"Liberar stocker",type:"success",controller:"promptStockerRemoveController"})},o.promptStockerRemovePanel=function(e){r.modal({scope:o,route:e,title:"Remover panel de stocker",type:"danger",controller:"promptStockerRemovePanelController"})}}]),app.controller("promptStockerSetController",["$scope","$rootScope","$timeout","Stocker",function(o,e,r,t){var n=e.$on("modal:hide",function(o,t){r(function(){e.scannerListener=!0}),n()}),c=e.$on("modal:show",function(o,t){r(function(){e.scannerListener=!1}),c()});o.$on("prompt:enter",function(o,e){t.add(e.prompt_value),e.dialog.close()})}]),app.controller("promptStockerRemoveController",["$scope","$rootScope","$timeout","Stocker",function(o,e,r,t){var n=e.$on("modal:hide",function(o,t){r(function(){e.scannerListener=!0}),n()}),c=e.$on("modal:show",function(o,t){r(function(){e.scannerListener=!1}),c()});o.$on("prompt:enter",function(o,e){t.remove(e.prompt_value),e.dialog.close()})}]),app.controller("promptStockerAddPanelController",["$scope","$rootScope","$timeout","Stocker",function(o,e,r,t){var n=e.$on("modal:hide",function(o,t){r(function(){e.scannerListener=!0}),n()}),c=e.$on("modal:show",function(o,t){r(function(){e.scannerListener=!1}),c()});o.$on("prompt:enter",function(o,e){t.panelAdd(e.prompt_value),e.dialog.close()})}]),app.controller("promptStockerRemovePanelController",["$scope","$rootScope","$timeout","Stocker",function(o,e,r,t){var n=e.$on("modal:hide",function(o,t){r(function(){e.scannerListener=!0}),n()}),c=e.$on("modal:show",function(o,t){r(function(){e.scannerListener=!1}),c()});o.$on("prompt:enter",function(o,e){t.panelRemove(e.prompt_value),e.dialog.close()})}]),app.controller("promptAoiSetController",["$scope","$rootScope","$timeout","IaCore","Aoi",function(o,e,r,t,n){var c=e.$on("modal:hide",function(o,t){r(function(){e.scannerListener=!0}),c()}),i=e.$on("modal:show",function(o,t){r(function(){e.scannerListener=!1}),i()});o.$on("prompt:enter",function(o,r){e.restartAoiData(r.prompt_value),r.dialog.close()})}]),app.controller("btnFormSelectOpController",["$scope","$rootScope","$timeout","IaCore","Aoi",function(o,e,r,t,n){var c=e.$on("modal:hide",function(o,t){r(function(){e.scannerListener=!0,e.btnFormSelectOpProccessing=!1}),c()}),i=e.$on("modal:show",function(o,t){r(function(){e.scannerListener=!1,e.btnFormSelectOpProccessing=!1}),i()})}]),app.factory("Stocker",["$q","$rootScope","IaCore","toasty","Panel",function(o,e,r,t,n){var c,i=8,a=function(o,e){return 0===o.indexOf(e)},s={};return s.autoscroll=function(o){var e=$("#stocker_box div.panel_trace"),r=$("#panel_"+o);r.offset()&&e.animate({scrollTop:r.offset().top-e.offset().top+e.scrollTop()})},s.nodeInit=function(o){c=o,c.on("stocker:info:response",function(o,r){t.clear(r),o&&(o.error?console.log("Error",o):(e.stockerService=o,s.autoscroll(e.stockerService.stocker.paneles))),e.$digest()}),c.on("stocker:add:response",function(o,r){t.clear(r),o&&(o.error?t.error({title:"Stocker",msg:o.error,timeout:5e3}):(t.success({title:"Stocker",msg:"Agregado correctamente",timeout:2e3}),e.stockerService=o)),console.log("stocker:add:response",o),e.$digest()}),c.on("stocker:remove:response",function(o,r){t.clear(r),o&&(o.error?t.error({title:"Stocker",msg:o.error,timeout:5e3}):(t.success({title:"Stocker",msg:"Libreado correctamente",timeout:2e3}),o.id==e.stockerService.id&&(e.stockerService={}))),console.log("stocker:remove:response",o),e.$digest()}),c.on("stocker:config:response",function(o,r){if(t.clear(r),o)if(o.error||o.trycatch){var n=o.error;o.trycatch&&(n="Error "+o.trycatch.statusCode),t.error({title:"Stocker",msg:n,timeout:5e3})}else t.success({title:"Stocker",msg:"Configurado correctamente",timeout:2e3}),e.stockerConfigModeHide(),e.stockerService=o.stocker;console.log("stocker:config:response",o),e.$digest()}),c.on("panel:add:response",function(o,r){t.clear(r),o&&(o.error?t.error({title:"Stocker",msg:o.error,timeout:5e3}):(t.success({title:"Panel",msg:"Agregado correctamente",timeout:2e3}),e.stockerService=o,s.autoscroll(o.paneles))),console.log("panel:add:response",o),e.$digest()}),c.on("panel:remove:response",function(o,r){t.clear(r),o&&(o.error?t.error({title:"Stocker",msg:o.error,timeout:5e3}):t.success({title:"Panel",msg:"Removido correctamente",timeout:2e3})),console.log("panel:remove:response",o),e.$digest()})},s.valid=function(o){return!!o&&!(!a(o.toUpperCase(),"STK")||o.length!=i)},s.add=function(o){o=o.toUpperCase(),s.valid(o)&&t.wait({title:"Stocker",msg:"Agregando stocker a produccion",timeout:!1,onAdd:function(){c.emit("stocker:add",o,this.id)}})},s.remove=function(o){o=o.toUpperCase(),s.valid(o)&&t.wait({title:"Stocker",msg:"Liberando de produccion",timeout:!1,onAdd:function(){c.emit("stocker:remove",o,this.id)}})},s.panelAdd=function(o){n.valid(o)&&t.wait({title:"Panel",msg:"Agregando panel al stocker",timeout:!1,onAdd:function(){c.emit("panel:add",o,this.id)}})},s.panelRemove=function(o){n.valid(o)&&t.wait({title:"Panel",msg:"Removiendo panel de stocker",timeout:!1,onAdd:function(){c.emit("panel:remove",o,this.id)}})},s.config=function(o,r){null!=o&&null!=r&&t.wait({title:"Stocker",msg:"Configurando "+e.stockerService.barcode,timeout:!1,onAdd:function(){c.emit("stocker:config",e.stockerService.barcode,o,r,this.id)}})},s}]);